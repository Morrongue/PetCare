{% extends "base.html" %}
{% block content %}

<div class="space-y-6 max-w-7xl mx-auto px-4 sm:px-6">
  
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold text-white flex items-center">
        <i class="fas fa-users-cog text-olive-500 mr-3"></i>
        User Management
      </h1>
      <p class="text-gray-400 mt-1 text-sm sm:text-base">Manage system users and permissions</p>
    </div>
    
    <a href="{% url 'admin_users_add' %}" 
       class="inline-flex items-center justify-center space-x-2 bg-gradient-to-r from-olive-700 to-olive-600 
              hover:from-olive-600 hover:to-olive-500 text-white font-semibold px-4 sm:px-6 py-2 sm:py-3 rounded-lg
              transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-olive-500/50
              w-full sm:w-auto text-sm sm:text-base">
      <i class="fas fa-user-plus"></i>
      <span>Add User</span>
    </a>
  </div>

  <!-- Mensajes -->
  {% if messages %}
    {% for message in messages %}
      <div class="p-3 sm:p-4 rounded-lg {% if message.tags == 'success' %}bg-green-900/30 border border-green-700 text-green-300{% else %}bg-red-900/30 border border-red-700 text-red-300{% endif %} text-sm sm:text-base">
        <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} mr-2"></i>
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  {% if usuarios %}
    <!-- Stats r√°pidas - Mobile mejorado -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
      <div class="bg-dark-800 border border-dark-700 rounded-xl p-3 sm:p-4 flex items-center space-x-2 sm:space-x-4">
        <div class="w-8 h-8 sm:w-12 sm:h-12 bg-blue-700 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-users text-white text-sm sm:text-xl"></i>
        </div>
        <div class="min-w-0">
          <p class="text-gray-400 text-xs sm:text-sm truncate">Total Users</p>
          <p class="text-lg sm:text-2xl font-bold text-white">{{ total_usuarios }}</p>
        </div>
      </div>
      
      <div class="bg-dark-800 border border-dark-700 rounded-xl p-3 sm:p-4 flex items-center space-x-2 sm:space-x-4">
        <div class="w-8 h-8 sm:w-12 sm:h-12 bg-orange-700 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-user-shield text-white text-sm sm:text-xl"></i>
        </div>
        <div class="min-w-0">
          <p class="text-gray-400 text-xs sm:text-sm truncate">Admins</p>
          <p class="text-lg sm:text-2xl font-bold text-white">{{ total_admins }}</p>
        </div>
      </div>

      <div class="bg-dark-800 border border-dark-700 rounded-xl p-3 sm:p-4 flex items-center space-x-2 sm:space-x-4">
        <div class="w-8 h-8 sm:w-12 sm:h-12 bg-purple-700 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-user-md text-white text-sm sm:text-xl"></i>
        </div>
        <div class="min-w-0">
          <p class="text-gray-400 text-xs sm:text-sm truncate">Vets</p>
          <p class="text-lg sm:text-2xl font-bold text-white">{{ total_vets }}</p>
        </div>
      </div>

      <div class="bg-dark-800 border border-dark-700 rounded-xl p-3 sm:p-4 flex items-center space-x-2 sm:space-x-4">
        <div class="w-8 h-8 sm:w-12 sm:h-12 bg-olive-700 rounded-lg flex items-center justify-center flex-shrink-0">
          <i class="fas fa-user text-white text-sm sm:text-xl"></i>
        </div>
        <div class="min-w-0">
          <p class="text-gray-400 text-xs sm:text-sm truncate">Clients</p>
          <p class="text-lg sm:text-2xl font-bold text-white">{{ total_clients }}</p>
        </div>
      </div>
    </div>

    <!-- Buscador Avanzado - Mobile optimized -->
    <div class="bg-dark-800 border border-dark-700 rounded-xl p-4 sm:p-6 shadow-xl">
      <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:items-center gap-3">
        <!-- Search Input -->
        <div class="flex-1 relative">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm sm:text-base"></i>
          <input type="text" 
                 id="searchInput"
                 placeholder="Search users..."
                 class="w-full bg-dark-900 border border-dark-600 rounded-lg pl-10 sm:pl-12 pr-4 py-2 sm:py-3 text-white text-sm sm:text-base
                        focus:outline-none focus:ring-2 focus:ring-olive-600 focus:border-transparent
                        transition-all duration-300"
                 oninput="searchUsers()">
        </div>

        <!-- Filter by Role -->
        <div class="sm:w-48">
          <select id="roleFilter" 
                  onchange="searchUsers()"
                  class="w-full bg-dark-900 border border-dark-600 rounded-lg px-3 sm:px-4 py-2 sm:py-3 text-white text-sm sm:text-base
                         focus:outline-none focus:ring-2 focus:ring-olive-600 focus:border-transparent
                         transition-all duration-300">
            <option value="">All Roles</option>
            <option value="Administrador">üëë Admin</option>
            <option value="Veterinario">üë®‚Äç‚öïÔ∏è Vet</option>
            <option value="Cliente">üë§ Client</option>
          </select>
        </div>

        <!-- Clear Button -->
        <button onclick="clearSearch()"
                class="bg-dark-900 hover:bg-dark-700 text-gray-300 hover:text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg
                       transition-all duration-300 border border-dark-600 hover:border-olive-600 text-sm sm:text-base
                       flex items-center justify-center space-x-2">
          <i class="fas fa-times"></i>
          <span class="sm:inline">Clear</span>
        </button>
      </div>

      <!-- Search Results Counter -->
      <div class="mt-3 flex flex-col sm:flex-row sm:items-center justify-between gap-1">
        <p class="text-xs sm:text-sm text-gray-400">
          <span id="resultCount">{{ total_usuarios }}</span> users found
        </p>
        <p class="text-xs text-gray-500 hidden sm:block">
          <i class="fas fa-info-circle mr-1"></i>
          Search across all columns
        </p>
      </div>
    </div>

    <!-- Tabla de usuarios - Mobile Cards / Desktop Table -->
    <div class="bg-dark-800 border border-dark-700 rounded-xl overflow-hidden shadow-xl">
      
      <!-- Desktop Table (hidden on mobile) -->
      <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-dark-900 border-b border-dark-700">
            <tr>
              <th class="px-4 sm:px-6 py-3 text-left text-sm font-semibold text-gray-300">
                <i class="fas fa-user text-olive-500 mr-2"></i>User
              </th>
              <th class="px-4 sm:px-6 py-3 text-left text-sm font-semibold text-gray-300">
                <i class="fas fa-envelope text-olive-500 mr-2"></i>Email
              </th>
              <th class="px-4 sm:px-6 py-3 text-left text-sm font-semibold text-gray-300">
                <i class="fas fa-phone text-olive-500 mr-2"></i>Phone
              </th>
              <th class="px-4 sm:px-6 py-3 text-left text-sm font-semibold text-gray-300">
                <i class="fas fa-map-marker-alt text-olive-500 mr-2"></i>Address
              </th>
              <th class="px-4 sm:px-6 py-3 text-left text-sm font-semibold text-gray-300">
                <i class="fas fa-shield-alt text-olive-500 mr-2"></i>Role
              </th>
              <th class="px-4 sm:px-6 py-3 text-center text-sm font-semibold text-gray-300">
                <i class="fas fa-cog text-olive-500 mr-2"></i>Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-dark-700" id="usersTableBody">
            {% for usuario in usuarios %}
              <tr class="hover:bg-dark-900 transition-colors group user-row"
                  data-username="{{ usuario.User|lower }}"
                  data-email="{{ usuario.Email|lower }}"
                  data-phone="{{ usuario.Phone|default:''|lower }}"
                  data-address="{{ usuario.Address|default:''|lower }}"
                  data-role="{{ usuario.Rol }}">
                
                <!-- Username con avatar -->
                <td class="px-4 sm:px-6 py-3">
                  <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br 
                                {% if usuario.Rol == 'Administrador' %}from-orange-700 to-orange-600
                                {% elif usuario.Rol == 'Veterinario' %}from-purple-700 to-purple-600
                                {% else %}from-olive-700 to-olive-600{% endif %}
                                flex items-center justify-center text-white font-bold text-sm">
                      {{ usuario.User|slice:":1"|upper }}
                    </div>
                    <div class="min-w-0">
                      <p class="text-white font-medium username-text truncate">{{ usuario.User }}</p>
                      <p class="text-gray-500 text-xs">ID: {{ usuario.id }}</p>
                    </div>
                  </div>
                </td>

                <!-- Email -->
                <td class="px-4 sm:px-6 py-3">
                  <p class="text-gray-300 email-text truncate">{{ usuario.Email }}</p>
                </td>

                <!-- Phone -->
                <td class="px-4 sm:px-6 py-3">
                  {% if usuario.Phone %}
                    <div class="flex items-center text-gray-300 phone-text">
                      <i class="fas fa-phone text-olive-500 mr-2 text-xs hidden sm:inline"></i>
                      <span class="truncate">{{ usuario.Phone }}</span>
                    </div>
                  {% else %}
                    <span class="text-gray-600 italic text-xs sm:text-sm">Not provided</span>
                  {% endif %}
                </td>

                <!-- Address -->
                <td class="px-4 sm:px-6 py-3">
                  {% if usuario.Address %}
                    <div class="flex items-center text-gray-300 address-text">
                      <i class="fas fa-map-marker-alt text-olive-500 mr-2 text-xs hidden sm:inline"></i>
                      <span class="truncate">{{ usuario.Address|truncatewords:3 }}</span>
                    </div>
                  {% else %}
                    <span class="text-gray-600 italic text-xs sm:text-sm">Not provided</span>
                  {% endif %}
                </td>

                <!-- Role con badge -->
                <td class="px-4 sm:px-6 py-3">
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold
                               {% if usuario.Rol == 'Administrador' %}bg-orange-700/30 text-orange-400 border border-orange-700
                               {% elif usuario.Rol == 'Veterinario' %}bg-purple-700/30 text-purple-400 border border-purple-700
                               {% else %}bg-olive-700/30 text-olive-400 border border-olive-700{% endif %}">
                    <i class="fas 
                       {% if usuario.Rol == 'Administrador' %}fa-user-shield
                       {% elif usuario.Rol == 'Veterinario' %}fa-user-md
                       {% else %}fa-user{% endif %} mr-1"></i>
                    <span class="hidden sm:inline">{{ usuario.Rol }}</span>
                    <span class="sm:hidden">
                      {% if usuario.Rol == 'Administrador' %}Admin
                      {% elif usuario.Rol == 'Veterinario' %}Vet
                      {% else %}Client{% endif %}
                    </span>
                  </span>
                </td>

                <!-- Actions -->
                <td class="px-4 sm:px-6 py-3">
            
                <div class="flex items-center justify-end pt-3 border-t border-dark-700 gap-2">
                    <a href="{% url 'admin_users_edit' usuario.id %}" 
                      class="flex-1 sm:flex-none bg-olive-700 hover:bg-olive-600 text-white px-3 py-2 rounded-lg
                              transition-colors duration-300 text-xs font-medium inline-flex items-center justify-center"
                      title="Edit user">
                      <i class="fas fa-edit mr-1"></i>
                      <span>Edit</span>
                    </a>
                    
                    <a href="{% url 'admin_users_reset_password' usuario.id %}"
                      class="flex-1 sm:flex-none bg-blue-700 hover:bg-blue-600 text-white px-3 py-2 rounded-lg
                              transition-colors duration-300 text-xs font-medium inline-flex items-center justify-center"
                      title="Reset password">
                      <i class="fas fa-key mr-1"></i>
                      <span>Reset</span>
                    </a>
                    
                    <a href="{% url 'admin_users_delete' usuario.id %}" 
                      onclick="return confirm('Are you sure you want to delete {{ usuario.User }}? This action cannot be undone.');"
                      class="flex-1 sm:flex-none bg-red-900/50 hover:bg-red-900 text-red-300 hover:text-white px-3 py-2 rounded-lg
                              transition-colors duration-300 text-xs font-medium border border-red-700 inline-flex items-center justify-center"
                      title="Delete user">
                      <i class="fas fa-trash-alt mr-1"></i>
                      <span>Delete</span>
                    </a>
                </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mobile Cards (hidden on desktop) -->
      <div class="md:hidden space-y-3 p-4" id="mobileUsersList">
        {% for usuario in usuarios %}
          <div class="bg-dark-900 border border-dark-700 rounded-xl p-4 user-row mobile-user-card"
               data-username="{{ usuario.User|lower }}"
               data-email="{{ usuario.Email|lower }}"
               data-phone="{{ usuario.Phone|default:''|lower }}"
               data-address="{{ usuario.Address|default:''|lower }}"
               data-role="{{ usuario.Rol }}">
            
            <!-- Header with avatar and basic info -->
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center space-x-3 flex-1 min-w-0">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br 
                            {% if usuario.Rol == 'Administrador' %}from-orange-700 to-orange-600
                            {% elif usuario.Rol == 'Veterinario' %}from-purple-700 to-purple-600
                            {% else %}from-olive-700 to-olive-600{% endif %}
                            flex items-center justify-center text-white font-bold flex-shrink-0">
                  {{ usuario.User|slice:":1"|upper }}
                </div>
                <div class="min-w-0 flex-1">
                  <p class="text-white font-medium username-text truncate">{{ usuario.User }}</p>
                  <p class="text-gray-400 text-xs truncate email-text">{{ usuario.Email }}</p>
                </div>
              </div>
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold
                           {% if usuario.Rol == 'Administrador' %}bg-orange-700/30 text-orange-400 border border-orange-700
                           {% elif usuario.Rol == 'Veterinario' %}bg-purple-700/30 text-purple-400 border border-purple-700
                           {% else %}bg-olive-700/30 text-olive-400 border border-olive-700{% endif %}">
                <i class="fas 
                   {% if usuario.Rol == 'Administrador' %}fa-user-shield
                   {% elif usuario.Rol == 'Veterinario' %}fa-user-md
                   {% else %}fa-user{% endif %} mr-1"></i>
                {% if usuario.Rol == 'Administrador' %}Admin
                {% elif usuario.Rol == 'Veterinario' %}Vet
                {% else %}Client{% endif %}
              </span>
            </div>

            <!-- Contact Info -->
            <div class="space-y-2 mb-3">
              {% if usuario.Phone %}
              <div class="flex items-center text-gray-300 text-sm phone-text">
                <i class="fas fa-phone text-olive-500 mr-2 w-4"></i>
                <span class="truncate">{{ usuario.Phone }}</span>
              </div>
              {% endif %}
              
              {% if usuario.Address %}
              <div class="flex items-center text-gray-300 text-sm address-text">
                <i class="fas fa-map-marker-alt text-olive-500 mr-2 w-4"></i>
                <span class="truncate">{{ usuario.Address }}</span>
              </div>
              {% endif %}
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-between pt-3 border-t border-dark-700">
              <div class="text-xs text-gray-500">
                ID: {{ usuario.id }}
              </div>
              <div class="flex items-center space-x-2">
                <a href="{% url 'admin_users_edit' usuario.id %}" 
                   class="bg-olive-700 hover:bg-olive-600 text-white px-3 py-1.5 rounded-lg
                          transition-colors duration-300 text-xs font-medium inline-flex items-center"
                   title="Edit user">
                  <i class="fas fa-edit"></i>
                </a>
                
                <a href="{% url 'admin_users_reset_password' usuario.id %}"
                   class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg
                          transition-colors duration-300 text-xs font-medium inline-flex items-center"
                   title="Reset password">
                  <i class="fas fa-key"></i>
                </a>
                
                <a href="{% url 'admin_users_delete' usuario.id %}" 
                   onclick="return confirm('Are you sure you want to delete {{ usuario.User }}? This action cannot be undone.');"
                   class="bg-red-900/50 hover:bg-red-900 text-red-300 hover:text-white px-3 py-1.5 rounded-lg
                          transition-colors duration-300 text-xs font-medium border border-red-700 inline-flex items-center"
                   title="Delete user">
                  <i class="fas fa-trash-alt"></i>
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- No Results Message -->
      <div id="noResults" class="hidden p-8 sm:p-12 text-center">
        <div class="max-w-md mx-auto">
          <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 bg-dark-700 rounded-full flex items-center justify-center">
            <i class="fas fa-search text-gray-600 text-2xl sm:text-3xl"></i>
          </div>
          <h3 class="text-lg sm:text-xl font-bold text-white mb-2">No users found</h3>
          <p class="text-gray-400 mb-4 text-sm sm:text-base">
            Try adjusting your search terms or filters
          </p>
          <button onclick="clearSearch()"
                  class="bg-olive-700 hover:bg-olive-600 text-white px-4 sm:px-6 py-2 rounded-lg
                         transition-colors duration-300 text-sm sm:text-base">
            <i class="fas fa-redo mr-2"></i>Clear Search
          </button>
        </div>
      </div>
    </div>

  {% else %}
    <!-- Estado vac√≠o -->
    <div class="bg-dark-800 border border-dark-700 rounded-2xl p-8 sm:p-12 text-center">
      <div class="max-w-md mx-auto">
        <div class="w-24 h-24 sm:w-32 sm:h-32 mx-auto mb-6 bg-gradient-to-br from-blue-800 to-blue-700 rounded-full 
                    flex items-center justify-center shadow-2xl">
          <i class="fas fa-users text-white text-3xl sm:text-5xl"></i>
        </div>

        <h3 class="text-xl sm:text-2xl font-bold text-white mb-3">No Users Yet</h3>
        <p class="text-gray-400 mb-6 text-sm sm:text-base">
          Start by adding your first user to the system.
        </p>

        <a href="{% url 'admin_users_add' %}" 
           class="inline-flex items-center justify-center space-x-2 bg-gradient-to-r from-olive-700 to-olive-600 
                  hover:from-olive-600 hover:to-olive-500 text-white font-semibold px-6 sm:px-8 py-3 rounded-lg
                  transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-olive-500/50
                  w-full sm:w-auto text-sm sm:text-base">
          <i class="fas fa-user-plus"></i>
          <span>Add First User</span>
        </a>
      </div>
    </div>
  {% endif %}

</div>

<!-- Script para b√∫squeda y animaciones -->
<script>
  // Variables globales
  let allRows = [];
  let allMobileCards = [];
  
  // Inicializar al cargar
  document.addEventListener('DOMContentLoaded', function() {
    allRows = Array.from(document.querySelectorAll('.user-row'));
    allMobileCards = Array.from(document.querySelectorAll('.mobile-user-card'));
    
    // Animaci√≥n de entrada para desktop
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
      row.style.opacity = '0';
      row.style.transform = 'translateX(-20px)';
      
      setTimeout(() => {
        row.style.transition = 'all 0.5s ease-in-out';
        row.style.opacity = '1';
        row.style.transform = 'translateX(0)';
      }, index * 50);
    });

    // Animaci√≥n de entrada para mobile
    const mobileCards = document.querySelectorAll('.mobile-user-card');
    mobileCards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      
      setTimeout(() => {
        card.style.transition = 'all 0.5s ease-in-out';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 50);
    });
  });

  // Funci√≥n principal de b√∫squeda
  function searchUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const roleFilter = document.getElementById('roleFilter').value;
    
    let visibleCount = 0;

    // Search in desktop table
    allRows.forEach(row => {
      const matches = shouldShowRow(row, searchTerm, roleFilter);
      row.style.display = matches ? '' : 'none';
      if (matches) visibleCount++;
    });

    // Search in mobile cards
    allMobileCards.forEach(card => {
      const matches = shouldShowRow(card, searchTerm, roleFilter);
      card.style.display = matches ? '' : 'none';
      if (matches) visibleCount++;
    });

    // Actualizar contador
    document.getElementById('resultCount').textContent = visibleCount;

    // Mostrar/ocultar mensaje de "no results"
    const noResults = document.getElementById('noResults');
    const tableBody = document.getElementById('usersTableBody');
    const mobileList = document.getElementById('mobileUsersList');
    
    if (visibleCount === 0) {
      if (tableBody) tableBody.style.display = 'none';
      if (mobileList) mobileList.style.display = 'none';
      noResults.classList.remove('hidden');
    } else {
      if (tableBody) tableBody.style.display = '';
      if (mobileList) mobileList.style.display = '';
      noResults.classList.add('hidden');
    }
  }

  // Helper function to check if row/card should be shown
  function shouldShowRow(element, searchTerm, roleFilter) {
    const username = element.dataset.username || '';
    const email = element.dataset.email || '';
    const phone = element.dataset.phone || '';
    const address = element.dataset.address || '';
    const role = element.dataset.role || '';

    // B√∫squeda en todas las columnas
    const matchesSearch = !searchTerm || 
      username.includes(searchTerm) ||
      email.includes(searchTerm) ||
      phone.includes(searchTerm) ||
      address.includes(searchTerm);

    // Filtro por rol
    const matchesRole = !roleFilter || role === roleFilter;

    return matchesSearch && matchesRole;
  }

  // Limpiar b√∫squeda
  function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('roleFilter').value = '';
    searchUsers();
  }

  // B√∫squeda en tiempo real con debounce
  let searchTimeout;
  document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(searchUsers, 300);
  });

  // Enter key para buscar
  document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      clearTimeout(searchTimeout);
      searchUsers();
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K para focus en b√∫squeda
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('searchInput').focus();
    }
    
    // Escape para limpiar b√∫squeda
    if (e.key === 'Escape') {
      clearSearch();
      document.getElementById('searchInput').blur();
    }
  });
</script>

<!-- Estilos adicionales para mobile -->
<style>
  @media (max-width: 768px) {
    .mobile-user-card {
      animation: cardSlideIn 0.3s ease-out;
    }
  }

  @keyframes cardSlideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mejor scroll en mobile */
  .overflow-x-auto {
    -webkit-overflow-scrolling: touch;
  }
</style>

{% endblock %}